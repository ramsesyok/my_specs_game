# ストレージ（Storages）

Specs には、さまざまな用途に最適化された **複数のストレージ** が用意されています。  
まずは、基本的な概念から説明します。

---

## ストレージの基本

コンポーネントの `impl` ブロックで指定するのは、**`UnprotectedStorage`** です。  
`UnprotectedStorage` は **安全でない（unsafe）ゲッター** を提供し、  
**指定されたインデックスが有効かどうかをチェックしません**（エンティティの ID がそのままインデックスになる）。

エンティティにどのコンポーネントが関連付けられているかを **効率的に管理するため** に、  
[`hibitset`](https://github.com/slide-rs/hibitset) による **階層ビットセット（hierarchical bitsets）** を使用します。

> **注意:**  
> **ビットセット** の概念を知らなくても問題ありません。  
> **「コンポーネントが存在するエンティティを追跡するためのマスク」** があることだけ理解しておけば十分です。

### 階層ビットセットの仕組み

階層ビットセットは、**複数のレイヤーで構成されるビットセット** です。  
各 **上位レイヤー** は、**下位レイヤーの複数のビットを要約** します。

- **下位レイヤーのどれかに `1` があると、上位レイヤーも `1` になる**
- **上位レイヤーが `0` の場合、その範囲全体をスキップできる**
- **上位レイヤーが `1` の場合、次のレイヤーをチェックする**

現在、**4 層の階層構造** になっています。

---

## ストレージの種類と用途

以下に、各ストレージの概要を示します。

| ストレージの種類       | 説明                                               | 最適な用途                        |
|:----------------------:|----------------------------------------------------|----------------------------------|
| [`BTreeStorage`]       | `BTreeMap` を使用                                  | 特定の用途なし（汎用）           |
| [`DenseVecStorage`]    | リダイレクトテーブルを使用                         | 頻繁に使用されるコンポーネント   |
| [`HashMapStorage`]     | `HashMap` を使用                                   | 使用頻度が少ないコンポーネント   |
| [`NullStorage`]        | エンティティのフラグ管理に使用                     | 頻度に関係なく使用可能           |
| [`VecStorage`]         | **疎な `Vec`** を使用（空のスロットは未初期化）    | 一般的なコンポーネント向け       |
| [`DefaultVecStorage`]  | **疎な `Vec`** を使用（空のスロットは `Default`）  | 一般的なコンポーネント向け       |

[`BTreeStorage`]: #btreestorage
[`DenseVecStorage`]: #densevecstorage
[`HashMapStorage`]: #hashmapstorage
[`NullStorage`]: #nullstorage
[`VecStorage`]: #vecstorage
[`DefaultVecStorage`]: #defaultvecstorage

---

## スライス（Slices）

一部のストレージは、**コンポーネントのスライスアクセス** を提供します。

| ストレージの種類       | スライスの型        | 密度   | インデックス |
|:----------------------:|---------------------|--------|--------------|
| [`DenseVecStorage`]    | `&[T]`              | 密      | 任意         |
| [`VecStorage`]         | `&[MaybeUninit<T>]` | 疎      | `Entity::id()` |
| [`DefaultVecStorage`]  | `&[T]`              | 疎      | `Entity::id()` |

スライスは **最大限の効率を提供** しますが、  
多くの一般的な抽象化とは **互換性が低く、扱いが難しい** というデメリットがあります。

---

## 各ストレージの詳細

### `BTreeStorage`

- `BTreeMap` を使用
- 特定の用途に最適化されているわけではないが、汎用的に利用可能
- **「どのストレージを使うべきかわからない場合のデフォルト選択肢」**

---

### `DenseVecStorage`

- **2 つの `Vec` を使用**
  - **データ格納用の `Vec`**
  - **エンティティ ID をデータ格納インデックスに変換するリダイレクトテーブル**
- **`usize` より大きいコンポーネントに適している**（メモリ節約）
- **`as_slice()` / `as_mut_slice()` を提供**（`&[T]` を取得可能）
- ただし、スライスのインデックスは **エンティティ ID とは無関係** なので注意

---

### `HashMapStorage`

- `HashMap` を使用
- **非常に少数のエンティティにしか関連付かないコンポーネントに最適**
- **挿入コストが低く、データが密に格納される**
- ただし、**頻繁に使用するコンポーネントには向かない**（ハッシュ計算コストが発生）

---

### `NullStorage`

- **サイズゼロの型（ZST: Zero-Sized Type）を扱う**
- **エンティティに対してフラグを設定する用途に最適**
- **`MaskedStorage` を利用して挿入・削除時にマスクを変更**
- 例: `struct Synced;` を定義し、一部のエンティティだけネットワーク同期対象にする

---

### `VecStorage`

- **1 つの `Vec` を使用（`DenseVecStorage` のようなリダイレクトテーブルはなし）**
- **未使用スロットは未初期化のまま**
- **使用頻度の高いコンポーネントに適している**（例: 位置情報など）
- **使用頻度の低いコンポーネントには向かない**（無駄なメモリ消費が発生）
- `as_slice()` / `as_mut_slice()` で `&[MaybeUninit<T>]` を取得可能
- **スライスのインデックスは `Entity::id()` と対応**

---

### `DefaultVecStorage`

- **`VecStorage` とほぼ同じだが、未使用スロットを `Default` で埋める**
- **コンポーネントに `Default` の実装が必要**
- **メモリ書き込みが `VecStorage` より多くなる**
- `as_slice()` / `as_mut_slice()` で `&[T]` を取得可能
- **すべてのインデックスが初期化されているため、`Storage::mask()` の確認が不要**

---

## まとめ

- **`DenseVecStorage`** → **頻繁に使用するコンポーネント向け**
- **`VecStorage`** → **一般的なコンポーネント向け**
- **`HashMapStorage`** → **使用頻度の低いコンポーネント向け**
- **`NullStorage`** → **フラグ管理向け**
- **`BTreeStorage`** → **汎用的なストレージ**
- **`DefaultVecStorage`** → **`VecStorage` + `Default` 値**

---

次の章では、**システムデータの活用** について説明します。